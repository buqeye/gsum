
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>buqeyemodel.models &#8212; buqeyemodel 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  
   

  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">buqeyemodel 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../../index.html" class="text-logo">buqeyemodel</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../index.html">Docs</a></li>
              
                <li><a href="../index.html">Module code</a></li>
              
              <li>buqeyemodel.models</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <h1>Source code for buqeyemodel.models</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">theano</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">tt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pymc3.math</span> <span class="k">import</span> <span class="n">cartesian</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="k">as</span> <span class="nn">integrate</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">from</span> <span class="nn">.extras</span> <span class="k">import</span> <span class="n">Exponential</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">gaussian</span><span class="p">,</span> <span class="n">stabilize</span>
<span class="kn">from</span> <span class="nn">statsmodels.sandbox.distributions.mv_normal</span> <span class="k">import</span> <span class="n">MVT</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GPCoeffs&#39;</span><span class="p">,</span> <span class="s1">&#39;InCoeffs&#39;</span><span class="p">,</span> <span class="s1">&#39;MvBLM&#39;</span><span class="p">,</span> <span class="s1">&#39;GeoProcess&#39;</span><span class="p">,</span> <span class="s1">&#39;GeoSeries&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">CoeffBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class that sets up the observable coefficient model.</span>

<span class="sd">    This simply extracts and sets up the relevant variables to be used</span>
<span class="sd">    in the coefficient models.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">rm_orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Q_est</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="k">if</span> <span class="n">grid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xs</span> <span class="o">=</span> <span class="n">X</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cartesian</span><span class="p">(</span><span class="o">*</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q_est_func</span> <span class="o">=</span> <span class="n">Q_est</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span> <span class="o">=</span> <span class="n">Q_est</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span> <span class="o">=</span> <span class="n">Q_est</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q_est_func</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">),</span> \
            <span class="s2">&quot;Orders must match the number of coefficients&quot;</span>
        <span class="k">if</span> <span class="n">rm_orders</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rm_orders</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># self.orders = []</span>
        <span class="c1"># self.cs = []</span>
        <span class="c1"># for i, n in enumerate(orders):</span>
        <span class="c1">#     if i == 0:</span>
        <span class="c1">#         cn = obs[i] / (ref * self.Q_est**n)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         cn = (obs[i] - obs[i-1]) / (ref * self.Q_est**n)</span>

        <span class="c1">#     if n not in rm_orders:</span>
        <span class="c1">#         self.orders.append(n)</span>
        <span class="c1">#         self.cs.append(cn)</span>
        <span class="c1"># self.orders = np.array(self.orders)</span>

        <span class="c1"># Find differences but keep leading term</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Make coefficients</span>
        <span class="n">ordervec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span> <span class="o">/</span> <span class="p">(</span><span class="n">ref</span> <span class="o">*</span> <span class="n">Q</span><span class="o">**</span><span class="n">ordervec</span><span class="p">)</span>

        <span class="c1"># Remove unwanted orders</span>
        <span class="n">keep_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">rm_orders</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>

        <span class="c1"># Get max order</span>
        <span class="n">k_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">k_arg</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">k_arg</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>


<div class="viewcode-block" id="MvBLM"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.MvBLM">[docs]</a><span class="k">class</span> <span class="nc">MvBLM</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A multivariate Bayesian linear model class</span>

<span class="sd">    Implements a Bayesian linear model for an Nx1 vector Y::</span>

<span class="sd">        Y ~ N(H\beta, \sigma^2 R)</span>

<span class="sd">    with an Nxq matrix H, qx1 vector \beta, scalar \sigma^2, and NxN</span>
<span class="sd">    correlation matrix R. A normal-inverse-gamma prior is placed on \beta and</span>
<span class="sd">    \sigma^2::</span>

<span class="sd">        \beta, \sigma^2 ~ NIG(means, cov, shape, scale)</span>

<span class="sd">    The matrix H is generated by a basis function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># pm.Model.__init__(self, name=name, model=model)</span>
        <span class="c1"># CoeffBase.__init__(</span>
        <span class="c1">#     self, X=X, obs=obs, orders=orders, rm_orders=rm_orders,</span>
        <span class="c1">#     ref=ref, Q_est=Q_est, grid=grid)</span>

        <span class="k">if</span> <span class="n">corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">gaussian</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">corr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;corr must be callable&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr</span> <span class="o">=</span> <span class="n">corr</span>

        <span class="k">if</span> <span class="n">basis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;basis must be non-zero scalar or callable&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_function</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># if not callable(basis):</span>
        <span class="c1">#     raise ValueError(&#39;basis must be callable&#39;)</span>
        <span class="c1"># self.basis = basis</span>

        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dim must be greater than or equal to one&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">means</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;means length does not match dim&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">means</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;means must be 1d array or scalar&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means_0</span> <span class="o">=</span> <span class="n">means</span>
        <span class="c1"># self.mean_dim = len(self.means_0)</span>

        <span class="k">if</span> <span class="n">cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Shape of cov must be (dim, dim)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span> <span class="o">=</span> <span class="n">shape</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span> <span class="o">=</span> <span class="n">scale</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="n">cov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inv_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span>

    <span class="k">def</span> <span class="nf">_domain_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">isNumber</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">0</span><span class="o">*</span><span class="n">obj</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">isNumber</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">isNumber</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">dom_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">cols</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">obj</span> <span class="o">*</span> <span class="n">vec</span>
            <span class="k">return</span> <span class="n">dom_func</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must be a number or function&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;X and y must be 2d arrays&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;X row length must match y column length&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_corr_kwargs</span> <span class="o">=</span> <span class="n">corr_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">stabilize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inv_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def shape(self):</span>
    <span class="c1">#     &quot;&quot;&quot;The shape parameter a of the inverse gamma distribution&quot;&quot;&quot;</span>
    <span class="c1">#     return self._shape</span>

    <span class="c1"># def _update_shape(self):</span>
    <span class="c1">#     self._shape = self.shape_0 + self.N * self.num_y / 2.0</span>

    <span class="k">def</span> <span class="nf">_recompute_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="c1"># Must be non-empty and not equal to the defaults</span>
        <span class="k">return</span> <span class="n">corr_kwargs</span> <span class="ow">and</span> <span class="n">corr_kwargs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr_kwargs</span>

    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
        <span class="n">num_y</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span> <span class="o">+</span> <span class="n">N</span> <span class="o">*</span> <span class="n">num_y</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="c1"># @property</span>
    <span class="c1"># def scale(self):</span>
    <span class="c1">#     &quot;&quot;&quot;The scale parameter b of the inverse gamma distribution&quot;&quot;&quot;</span>
    <span class="c1">#     return self._scale</span>

    <span class="c1"># def _update_scale(self):</span>
    <span class="c1">#     means_0, inv_cov_0 = self.means_0, self.inv_cov_0</span>
    <span class="c1">#     means, inv_cov = self.means, self.inv_cov</span>
    <span class="c1">#     y, R_chol = self.y, self.R_chol</span>
    <span class="c1">#     val = np.dot(means_0.T, np.dot(inv_cov_0, means_0)) + \</span>
    <span class="c1">#         np.trace(np.dot(y, sp.linalg.cho_solve((R_chol, True), y.T))) - \</span>
    <span class="c1">#         np.dot(means.T, np.dot(inv_cov, means))</span>
    <span class="c1">#     self._scale = self.scale_0 + val / 2.0</span>

    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_corr</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span>

        <span class="c1"># Set up variables</span>
        <span class="n">means_0</span><span class="p">,</span> <span class="n">inv_cov_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span>
        <span class="n">means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">inv_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="c1"># if corr_kwargs:  # not empty dict</span>
        <span class="c1">#     R_chol = np.cholesky(stabilize(self.corr(self.X, **corr_kwargs)))</span>
        <span class="c1"># else:</span>
        <span class="c1">#     R_chol = self.R_chol</span>
        <span class="n">R_chol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chol</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="c1"># Compute quadratics</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">means_0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv_cov_0</span><span class="p">,</span> <span class="n">means_0</span><span class="p">))</span> <span class="o">+</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_solve</span><span class="p">((</span><span class="n">R_chol</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span> <span class="o">-</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">means</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv_cov</span><span class="p">,</span> <span class="n">means</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span> <span class="o">+</span> <span class="n">val</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="c1"># @property</span>
    <span class="c1"># def means(self):</span>
    <span class="c1">#     return self._means</span>

    <span class="c1"># def _update_means(self):</span>
    <span class="c1">#     Rinv_y = sp.linalg.cho_solve((self.R_chol, True), self.avg_y)</span>
    <span class="c1">#     val = np.dot(self.inv_cov_0, self.means_0) + \</span>
    <span class="c1">#         self.num_y * np.dot(self.H.T, Rinv_y)</span>
    <span class="c1">#     self._means = np.dot(self.cov, val)</span>

    <span class="k">def</span> <span class="nf">means</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_corr</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_means</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="n">num_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">avg_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">R_chol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chol</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="n">Rinv_y</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_solve</span><span class="p">((</span><span class="n">R_chol</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">avg_y</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">means_0</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">num_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Rinv_y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def cov(self):</span>
    <span class="c1">#     return self._cov</span>

    <span class="c1"># def _update_cov(self):</span>
    <span class="c1">#     right = sp.linalg.solve_triangular(self.R_chol, self.H, lower=True)</span>
    <span class="c1">#     quad = np.dot(right.T, right)</span>
    <span class="c1">#     self._inv_cov = self.inv_cov_0 + self.num_y * quad</span>
    <span class="c1">#     self._cov = np.linalg.inv(self.inv_cov)</span>

    <span class="k">def</span> <span class="nf">inv_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_corr</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_cov</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="n">num_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># num_y = num_y if num_y is not None else self.num_y</span>
        <span class="n">R_chol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chol</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>

        <span class="n">right</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve_triangular</span><span class="p">(</span><span class="n">R_chol</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span> <span class="o">+</span> <span class="n">num_y</span> <span class="o">*</span> <span class="n">quad</span>

    <span class="k">def</span> <span class="nf">cov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_corr</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_cov</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">))</span>

    <span class="c1"># @property</span>
    <span class="c1"># def inv_cov(self):</span>
    <span class="c1">#     return self._inv_cov</span>

    <span class="c1"># @property</span>
    <span class="c1"># def R(self):</span>
    <span class="c1">#     return self._R</span>

    <span class="c1"># @R.setter</span>
    <span class="c1"># def R(self, value):</span>
    <span class="c1">#     &quot;&quot;&quot;Setter that ensures parameters remain in sync&quot;&quot;&quot;</span>
    <span class="c1">#     self._R = value</span>
    <span class="c1">#     self.R_chol = np.linalg.cholesky(self.R)</span>
    <span class="c1">#     # Must be in the following order:</span>
    <span class="c1">#     self._update_cov()</span>
    <span class="c1">#     self._update_means()</span>
    <span class="c1">#     self._update_scale()</span>

    <span class="k">def</span> <span class="nf">chol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_corr</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">stabilize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chol</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>

    <span class="c1"># @y.setter</span>
    <span class="c1"># def y(self, value):</span>
    <span class="c1">#     &quot;&quot;&quot;Setter that ensures parameters remain in sync&quot;&quot;&quot;</span>
    <span class="c1">#     self._y = np.asarray(value)</span>
    <span class="c1">#     self.avg_y = np.average(self.y, axis=0)</span>
    <span class="c1">#     if (self.num_y, self.N) != self.y.shape:</span>
    <span class="c1">#         raise ValueError(&#39;y must remain the same shape&#39;)</span>
    <span class="c1">#     # Must be in the following order:</span>
    <span class="c1">#     self._update_shape()</span>
    <span class="c1">#     self._update_means()</span>
    <span class="c1">#     self._update_scale()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span>

    <span class="c1"># @property</span>
    <span class="c1"># def H(self):</span>
    <span class="c1">#     return self._H</span>

    <span class="k">def</span> <span class="nf">t_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_corr</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
            <span class="n">corr_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr_kwargs</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span>
        <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">R</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">means</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">/</span> <span class="n">shape</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shape</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span>

    <span class="k">def</span> <span class="nf">_build_conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">Xnew</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="c1"># Set up variables</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_corr</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
            <span class="n">corr_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr_kwargs</span>
        <span class="n">R_12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">Xp</span><span class="o">=</span><span class="n">Xnew</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">R_21</span> <span class="o">=</span> <span class="n">R_12</span><span class="o">.</span><span class="n">T</span>
        <span class="n">R_22</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">Xnew</span><span class="p">,</span> <span class="n">Xp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="c1"># H = self.H</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">R_chol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chol</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">H_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">Xnew</span><span class="p">)</span>

        <span class="c1"># Compute conditional covariance</span>
        <span class="n">Rinv_R12</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_solve</span><span class="p">((</span><span class="n">R_chol</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">R_12</span><span class="p">)</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R_21</span><span class="p">,</span> <span class="n">Rinv_R12</span><span class="p">)</span>
        <span class="n">R_new</span> <span class="o">=</span> <span class="n">R_22</span> <span class="o">-</span> <span class="n">quad</span>
        <span class="k">if</span> <span class="n">corr_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">R_new</span> <span class="o">=</span> <span class="n">corr_scale</span> <span class="o">*</span> <span class="n">R_new</span>

        <span class="c1"># Conditional basis</span>
        <span class="n">Rinv_H</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_solve</span><span class="p">((</span><span class="n">R_chol</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">H</span><span class="p">)</span>
        <span class="n">H_new</span> <span class="o">=</span> <span class="n">H_2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R_21</span><span class="p">,</span> <span class="n">Rinv_H</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mean_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">H_new</span> <span class="o">=</span> <span class="n">mean_scale</span> <span class="o">*</span> <span class="n">H_new</span>

        <span class="c1"># Compute conditional parameters of t distribution</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_params</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">H_new</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R_new</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="n">Rinv_yn</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_solve</span><span class="p">((</span><span class="n">R_chol</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">y</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">mean_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R_21</span><span class="p">,</span> <span class="n">Rinv_yn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mean_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mean_correction</span> <span class="o">=</span> <span class="n">mean_scale</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">*</span> <span class="n">mean_correction</span>
        <span class="n">mean</span> <span class="o">+=</span> <span class="n">mean_correction</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span>

    <span class="k">def</span> <span class="nf">conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">Xnew</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_conditional</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">Xnew</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">corr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MVT</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">Xnew</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditional</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">Xnew</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="n">dob</span><span class="p">)</span>

<div class="viewcode-block" id="MvBLM.predictive"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.MvBLM.predictive">[docs]</a>    <span class="k">def</span> <span class="nf">predictive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a posterior predictive distribution object&quot;&quot;&quot;</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_params</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">corr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MVT</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictive</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="n">dob</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">inv_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">R_chol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chol</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="n">num_y</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">tr_log_R</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">R_chol</span><span class="p">)))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">logdet_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

        <span class="n">ev</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">num_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">tr_log_R</span><span class="p">)</span>
        <span class="n">ev</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">logdet_cov</span> <span class="o">-</span> \
            <span class="n">shape</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If non-zero</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">logdet_inv_cov_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_cov_0</span><span class="p">)</span>
            <span class="n">ev</span> <span class="o">+=</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span><span class="p">)</span> <span class="o">+</span> \
                <span class="mf">0.5</span> <span class="o">*</span> <span class="n">logdet_inv_cov_0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ev</span>

    <span class="k">def</span> <span class="nf">posterior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">logprior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">ev</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">val</span><span class="p">)}</span>
            <span class="c1"># print(val, np.squeeze(val))</span>
            <span class="c1"># print(corr_kwargs)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">corr_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">log_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logprior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_pdf</span> <span class="o">=</span> <span class="n">log_pdf</span> <span class="o">+</span> <span class="n">logprior</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">log_pdf</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">log_pdf</span><span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_pdf</span><span class="p">)</span>
            <span class="c1"># Integrate using trapezoid rule</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pdf</span><span class="o">/</span><span class="n">norm</span>
        <span class="k">return</span> <span class="n">log_pdf</span>

<div class="viewcode-block" id="MvBLM.corr_post"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.MvBLM.corr_post">[docs]</a>    <span class="k">def</span> <span class="nf">corr_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logprior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluates the posterior for the correlation parameters in corr_kwargs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        logprior : callable</span>
<span class="sd">        corr_kwargs : dict</span>
<span class="sd">            The values of the correlation parameters at which to evaluate the</span>
<span class="sd">            posterior. Because the evidence is vectorized, standard</span>
<span class="sd">            array broadcasting rules apply</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if not callable(logprior):</span>
        <span class="c1">#     raise ValueError(&#39;logprior must be callable&#39;)</span>

        <span class="n">vec_evidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="p">)</span>
        <span class="n">log_post</span> <span class="o">=</span> <span class="n">vec_evidence</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logprior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_post</span> <span class="o">=</span> <span class="n">log_post</span> <span class="o">+</span> <span class="n">logprior</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">log_post</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">log_post</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_post</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GeoProcess"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.GeoProcess">[docs]</a><span class="k">class</span> <span class="nc">GeoProcess</span><span class="p">(</span><span class="n">MvBLM</span><span class="p">):</span>
    <span class="sa">R</span><span class="sd">&quot;&quot;&quot;A geometric series with iid random processes as coefficients.</span>

<span class="sd">    Implements the following model</span>

<span class="sd">    .. math::</span>

<span class="sd">        X_k = X_{\mathrm{ref}} \sum_{n=0}^k c_n Q^n</span>

<span class="sd">    where the :math:`c_n` are Gaussian processes with parameters using</span>
<span class="sd">    conjugate priors</span>

<span class="sd">    .. math::</span>

<span class="sd">        c_n | \beta, \sigma^{2} &amp; \sim N(H \beta, \sigma^2 R) \\</span>
<span class="sd">        \beta, \sigma^2 &amp; \sim NIG(\mu, V, a, b)</span>

<span class="sd">    Conditioning on partial sums :math:`X_{0}`, :math:`\dots,` :math:`X_k`, allow</span>
<span class="sd">    one to estimate the full summation and obtain posteriors for the parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># @property</span>
    <span class="c1"># def orders(self):</span>
    <span class="c1">#     return self._orders</span>

    <span class="c1"># @orders.setter</span>
    <span class="c1"># def orders(self, value):</span>
    <span class="c1">#     value = np.asarray(value)</span>
    <span class="c1">#     if value.ndim != 1:</span>
    <span class="c1">#         raise ValueError(&#39;orders must be a 1d array&#39;)</span>
    <span class="c1">#     self._orders = value</span>
    <span class="c1">#     self.ordersvec = np.atleast_2d(self.orders).T</span>

    <span class="c1"># @property</span>
    <span class="c1"># def ratio(self):</span>
    <span class="c1">#     return self._ratio</span>

    <span class="c1"># @ratio.setter</span>
    <span class="c1"># def ratio(self, value):</span>
    <span class="c1">#     # First rescale coefficients</span>
    <span class="c1">#     if hasattr(self, &#39;ratio&#39;) and hasattr(self, &#39;y&#39;):</span>
    <span class="c1">#         old_ratio = self.ratio</span>
    <span class="c1">#         self.y = self.y * (old_ratio/value)**self.ordervec</span>
    <span class="c1">#     self._ratio = value</span>

    <span class="k">def</span> <span class="nf">_recompute_coeffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ratio_kwargs</span> <span class="ow">and</span> <span class="n">ratio_kwargs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ratio_kwargs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;recomputing...&#39;</span><span class="p">)</span>
            <span class="n">coeffs</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span>
                <span class="n">partials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partials</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">ref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">orders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_orders</span><span class="p">,</span>
                <span class="n">rm_orders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_orders</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">coeffs</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_scale_rv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="n">scale_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">scale_cols</span><span class="p">,</span> <span class="n">scale_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">scale_mat</span> <span class="o">=</span> <span class="n">scale_cols</span> <span class="o">*</span> <span class="n">scale_rows</span>
        <span class="k">return</span> <span class="n">scale_vec</span><span class="p">,</span> <span class="n">scale_mat</span>

    <span class="k">def</span> <span class="nf">_geom_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;start index of geometric sum cannot exceed end&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="n">start</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ratio_matrix_sums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_order</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">ratio_vec</span><span class="p">,</span> <span class="n">ratio_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_rv</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
        <span class="n">mu_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geom_sum</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">ratio_vec</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">corr_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geom_sum</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">ratio_mat</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mu_sum</span><span class="p">,</span> <span class="n">corr_sum</span>

    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">partials</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">rm_orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ratio_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="c1"># if corr_kwargs is None:</span>
        <span class="c1">#     corr_kwargs = {}</span>
        <span class="k">if</span> <span class="n">ratio_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ratio_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ratio_kwargs</span> <span class="o">=</span> <span class="n">ratio_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_orders</span> <span class="o">=</span> <span class="n">orders</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">partials</span> <span class="o">=</span> <span class="n">partials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_function</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_function</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

        <span class="n">coeffs</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span>
            <span class="n">partials</span><span class="o">=</span><span class="n">partials</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span>
            <span class="n">rm_orders</span><span class="o">=</span><span class="n">rm_orders</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordersvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_orders</span> <span class="o">=</span> <span class="n">rm_orders</span>

        <span class="c1"># Get max order</span>
        <span class="n">max_order_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="n">max_order_arg</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_partial</span> <span class="o">=</span> <span class="n">partials</span><span class="p">[</span><span class="n">max_order_arg</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeoProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">Xnew</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">predictive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">ratio_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="c1"># Set up variables</span>
        <span class="k">if</span> <span class="n">ratio_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ratio_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ratio_kwargs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_corr</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
            <span class="n">corr_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr_kwargs</span>
        <span class="n">R_12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">Xp</span><span class="o">=</span><span class="n">Xnew</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">R_21</span> <span class="o">=</span> <span class="n">R_12</span><span class="o">.</span><span class="n">T</span>
        <span class="n">R_22</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">Xnew</span><span class="p">,</span> <span class="n">Xp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">R_chol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chol</span><span class="p">(</span><span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="n">H_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">Xnew</span><span class="p">)</span>

        <span class="c1"># Compute conditional covariance</span>
        <span class="n">Rinv_R12</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_solve</span><span class="p">((</span><span class="n">R_chol</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">R_12</span><span class="p">)</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R_21</span><span class="p">,</span> <span class="n">Rinv_R12</span><span class="p">)</span>
        <span class="n">R_new</span> <span class="o">=</span> <span class="n">R_22</span> <span class="o">-</span> <span class="n">quad</span>

        <span class="c1"># Conditional basis</span>
        <span class="n">Rinv_H</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_solve</span><span class="p">((</span><span class="n">R_chol</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">H</span><span class="p">)</span>
        <span class="n">H_new</span> <span class="o">=</span> <span class="n">H_2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R_21</span><span class="p">,</span> <span class="n">Rinv_H</span><span class="p">)</span>

        <span class="n">mean_sc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_orders</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="p">]</span>
            <span class="n">mean_sc</span><span class="p">,</span> <span class="n">corr_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_rv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">))</span>
            <span class="n">mean_ref</span><span class="p">,</span> <span class="n">corr_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_rv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">Xnew</span><span class="p">))</span>
            <span class="n">mean_scale_lower</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">corr_scale_lower</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
                <span class="n">mean_scale_lower</span> <span class="o">+=</span> <span class="n">mean_sc</span><span class="o">**</span><span class="n">i</span>
                <span class="n">corr_scale_lower</span> <span class="o">+=</span> <span class="n">corr_sc</span><span class="o">**</span><span class="n">i</span>
            <span class="n">R_new</span> <span class="o">*=</span> <span class="n">corr_ref</span> <span class="o">*</span> <span class="n">corr_scale_lower</span>
            <span class="n">H_new</span> <span class="o">*=</span> <span class="n">mean_ref</span> <span class="o">*</span> <span class="n">mean_scale_lower</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_orders</span><span class="p">))])</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_orders</span><span class="p">,</span> <span class="n">orders</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">predictive</span><span class="p">:</span>
            <span class="n">H_pred</span><span class="p">,</span> <span class="n">R_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_predictive</span><span class="p">(</span>
                <span class="n">Xnew</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="n">max_order</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ratio_kwargs</span><span class="o">=</span><span class="n">ratio_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
            <span class="n">R_new</span> <span class="o">+=</span> <span class="n">R_pred</span>
            <span class="n">H_new</span> <span class="o">+=</span> <span class="n">H_pred</span>

        <span class="c1"># Compute conditional parameters of t distribution</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_params</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">H_new</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R_new</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="c1"># y = y if y is not None else self.y</span>
        <span class="n">coeffs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span>
                <span class="n">partials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partials</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">ref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">orders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_orders</span><span class="p">,</span>
                <span class="n">rm_orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">Rinv_yn</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_solve</span><span class="p">((</span><span class="n">R_chol</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">mean_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R_21</span><span class="p">,</span> <span class="n">Rinv_yn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mean_sc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mean_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mean_ref</span> <span class="o">*</span> <span class="n">mean_sc</span><span class="o">**</span><span class="n">orders</span> <span class="o">*</span> <span class="n">mean_correction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean_correction</span> <span class="o">=</span> <span class="n">mean_correction</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">mean</span> <span class="o">+=</span> <span class="n">mean_correction</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span>

    <span class="k">def</span> <span class="nf">conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Xnew</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">ratio_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ratio_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ratio_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ratio_kwargs</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_coeffs</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">==</span> <span class="n">order</span><span class="p">))</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_conditional</span><span class="p">(</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">Xnew</span><span class="o">=</span><span class="n">Xnew</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">,</span>
            <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">corr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MVT</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Xnew</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">ratio_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditional</span><span class="p">(</span><span class="n">Xnew</span><span class="o">=</span><span class="n">Xnew</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">,</span>
                                <span class="n">ratio_kwargs</span><span class="o">=</span><span class="n">ratio_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="n">dob</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_predictive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ratio_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="c1"># Sum contributions from geometric sum of ratios</span>
            <span class="k">if</span> <span class="n">max_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">max_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">ratio_mu</span><span class="p">,</span> <span class="n">ratio_corr</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_ratio_matrix_sums</span><span class="p">(</span><span class="n">max_order</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
            <span class="c1"># Also the overall multiplicative scale</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">ref_vec</span><span class="p">,</span> <span class="n">ref_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_rv</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="c1"># Scale basis and correlation</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">ref_vec</span> <span class="o">*</span> <span class="n">ratio_mu</span> <span class="o">*</span> <span class="n">H</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">ref_mat</span> <span class="o">*</span> <span class="n">ratio_corr</span> <span class="o">*</span> <span class="n">R</span>
        <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">R</span>

<div class="viewcode-block" id="GeoProcess.predictive"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.GeoProcess.predictive">[docs]</a>    <span class="k">def</span> <span class="nf">predictive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">ratio_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a posterior predictive distribution object&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ratio_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ratio_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ratio_kwargs</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_coeffs</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_conditional</span><span class="p">(</span>
                <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_order</span><span class="p">,</span> <span class="n">Xnew</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
                <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">predictive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="n">max_order</span><span class="p">,</span>
                <span class="n">ratio_kwargs</span><span class="o">=</span><span class="n">ratio_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_predictive</span><span class="p">(</span>
                <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="n">max_order</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">,</span>
                <span class="n">ratio_kwargs</span><span class="o">=</span><span class="n">ratio_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
            <span class="c1"># Integrate out means and variance</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_params</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">corr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MVT</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ratio_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictive</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="n">max_order</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">,</span>
            <span class="n">ratio_kwargs</span><span class="o">=</span><span class="n">ratio_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="n">dob</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ratio_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio_kwargs</span><span class="p">,</span> <span class="n">logprior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">logprior</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;logprior must be callable&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">ratio_ev</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_coeffs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_kwargs</span><span class="p">)</span>

        <span class="n">vec_evidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio_ev</span><span class="p">)</span>
        <span class="n">log_post</span> <span class="o">=</span> <span class="n">vec_evidence</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logprior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_post</span> <span class="o">=</span> <span class="n">log_post</span> <span class="o">+</span> <span class="n">logprior</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">log_post</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">log_post</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_post</span><span class="p">)</span></div>


<div class="viewcode-block" id="GeoSeries"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.GeoSeries">[docs]</a><span class="k">class</span> <span class="nc">GeoSeries</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">R</span><span class="sd">&quot;&quot;&quot;A geometric series with iid random variables as coefficients.</span>

<span class="sd">    Implements the following model</span>

<span class="sd">    .. math::</span>

<span class="sd">        X_k = X_{\mathrm{ref}} \sum_{n=0}^k c_n Q^n</span>

<span class="sd">    where the :math:`c_n` are iid Gaussians and :math:`\sigma^2` has a</span>
<span class="sd">    conjugate prior</span>

<span class="sd">    .. math::</span>

<span class="sd">        c_n | \sigma^2 &amp; \sim N(0, \sigma^2) \\</span>
<span class="sd">        \sigma^2 &amp; \sim IG(a, b)</span>

<span class="sd">    Conditioning on partial sums :math:`X_0`, :math:`\dots,` :math:`X_k`, allow</span>
<span class="sd">    one to estimate the full summation and obtain posteriors for the</span>
<span class="sd">    parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span> <span class="o">=</span> <span class="n">shape</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span> <span class="o">=</span> <span class="n">scale</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span>

    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partials</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">rm_orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ratio_kwargs</span> <span class="o">=</span> <span class="n">ratio_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_orders</span> <span class="o">=</span> <span class="n">orders</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">partials</span> <span class="o">=</span> <span class="n">partials</span>
        <span class="c1"># self.ratio = self._domain_function(ratio)</span>
        <span class="c1"># self.ref = self._domain_function(ref)</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">ratio</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>

        <span class="n">coeffs</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span>
            <span class="n">partials</span><span class="o">=</span><span class="n">partials</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span>
            <span class="n">rm_orders</span><span class="o">=</span><span class="n">rm_orders</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordersvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_orders</span> <span class="o">=</span> <span class="n">rm_orders</span>

        <span class="c1"># Get max order</span>
        <span class="n">max_order_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="n">max_order_arg</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_partial</span> <span class="o">=</span> <span class="n">partials</span><span class="p">[</span><span class="n">max_order_arg</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeffs</span> <span class="o">=</span> <span class="n">coeffs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combine</span> <span class="o">=</span> <span class="n">combine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_recompute_coeffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ratio_kwargs</span> <span class="ow">and</span> <span class="n">ratio_kwargs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ratio_kwargs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;recomputing...&#39;</span><span class="p">)</span>
            <span class="n">coeffs</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span>
                <span class="n">partials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partials</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">ref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_orders</span><span class="p">,</span>
                <span class="n">rm_orders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_orders</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">coeffs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeffs</span>

    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_coeffs</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">num_c</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span> <span class="o">+</span> <span class="n">num_c</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_coeffs</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">csq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeffs</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span> <span class="o">+</span> <span class="n">csq</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="k">def</span> <span class="nf">predictive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shape</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">/</span> <span class="n">shape</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_partial</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span>
            <span class="n">summed_ratio</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="n">order</span><span class="o">-</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">sd</span> <span class="o">*=</span> <span class="n">summed_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_partial</span>
        <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictive</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dob</span><span class="o">=</span><span class="n">dob</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_coeffs</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>
        <span class="n">num_c</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ev</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">num_c</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">ev</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="n">shape</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shape_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_0</span>
            <span class="n">scale_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_0</span>
            <span class="n">ev</span> <span class="o">+=</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">shape_0</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape_0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">scale_0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
            <span class="n">ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ev</span>

    <span class="k">def</span> <span class="nf">posterior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">logprior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">ev</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">val</span><span class="p">)}</span>
            <span class="c1"># print(val, np.squeeze(val))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">corr_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">,</span> <span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">ratio_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">log_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logprior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_pdf</span> <span class="o">=</span> <span class="n">log_pdf</span> <span class="o">+</span> <span class="n">logprior</span><span class="p">(</span><span class="o">**</span><span class="n">ratio_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">log_pdf</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">log_pdf</span><span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_pdf</span><span class="p">)</span>
            <span class="c1"># Integrate using trapezoid rule</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pdf</span><span class="o">/</span><span class="n">norm</span>
        <span class="k">return</span> <span class="n">log_pdf</span></div>


<div class="viewcode-block" id="GPCoeffs"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.GPCoeffs">[docs]</a><span class="k">class</span> <span class="nc">GPCoeffs</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">CoeffBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Treats observables as sums of weighted iid Gaussian processes.</span>

<span class="sd">    Parameters for the Gaussian process are conditioned on observable data to</span>
<span class="sd">    permit the extimation of the truncation error.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the observable. This name will be</span>
<span class="sd">        placed before all RV names defined within this model,</span>
<span class="sd">        i.e. &#39;name_sd&#39;.</span>
<span class="sd">    model : pymc3.Model object</span>
<span class="sd">        The parent model. If defined within a model context,</span>
<span class="sd">        it will use that one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">rm_orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Q_est</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">param_kwargs</span><span class="p">):</span>
        <span class="c1"># Can&#39;t use super since pm.Model doesn&#39;t accept kwargs</span>
        <span class="c1"># super(GPCoeffs, self).__init__(name=name, model=model)</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="n">CoeffBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">rm_orders</span><span class="o">=</span><span class="n">rm_orders</span><span class="p">,</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">Q_est</span><span class="o">=</span><span class="n">Q_est</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">build</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">def_params</span><span class="p">(</span><span class="o">**</span><span class="n">param_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gp_model</span><span class="p">()</span>

<div class="viewcode-block" id="GPCoeffs.get_RV"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.GPCoeffs.get_RV">[docs]</a>    <span class="k">def</span> <span class="nf">get_RV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check both self and parent model for rv&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rv</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">rv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var</span></div>

    <span class="k">def</span> <span class="nf">def_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># Add a shape key to ls dict for anisotropic models</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;shape&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
            <span class="n">ls_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ls_size</span> <span class="o">=</span> <span class="n">ls</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sd_size</span> <span class="o">=</span> <span class="n">ls</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sd_size</span> <span class="o">&gt;</span> <span class="n">ls_size</span><span class="p">:</span>
                    <span class="n">ls_size</span> <span class="o">=</span> <span class="n">sd_size</span>
            <span class="k">if</span> <span class="n">ls_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ls</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ls_size</span>

        <span class="c1"># Convert non-dicts to dicts holding observed value</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">q</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;observed&#39;</span><span class="p">:</span> <span class="n">arg</span><span class="p">}</span>
        <span class="p">[</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

        <span class="c1"># Entering self ensures RVs are in the context of this instance</span>
        <span class="c1"># even if this method is called manually</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">Lognormal</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">sd</span><span class="p">)</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">Lognormal</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">ls</span><span class="p">)</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">sigma</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Lognormal</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">q</span><span class="p">)</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">gp_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># Get predefined parameters</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">)</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">)</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># If q hasn&#39;t been defined</span>
                <span class="n">q</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>

            <span class="c1"># Define Q if it has been overlooked</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># If q isn&#39;t an RV</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">as_tensor_variable</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># If Q is already defined</span>
                <span class="k">pass</span>

            <span class="c1"># Setup mean and covariance functions</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">*</span> <span class="n">Exponential</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">nlinalg</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">orders</span><span class="p">))</span>
            <span class="n">coregion</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">Coregion</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">)</span>
            <span class="n">covs</span> <span class="o">=</span> <span class="p">[</span><span class="n">coregion</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span>  <span class="c1"># Create cov for each grid entry</span>
                <span class="n">Xgp</span> <span class="o">=</span> <span class="p">[</span><span class="n">orders</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs</span><span class="p">]</span>
                <span class="n">num_Xs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">X</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs</span><span class="p">):</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ls_i</span> <span class="o">=</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># Smaller length than Xs</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Anisotropic models must have a distinct&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;length scale for each entry in Xs&quot;</span><span class="p">)</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>  <span class="c1"># Is scalar-like</span>
                        <span class="n">ls_i</span> <span class="o">=</span> <span class="n">ls</span>
                    <span class="n">cov</span> <span class="o">=</span> <span class="n">sd</span><span class="o">**</span><span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="n">num_Xs</span><span class="p">)</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">ExpQuad</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls_i</span><span class="p">)</span>
                    <span class="n">covs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
                <span class="n">ccov</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">Kron</span><span class="p">(</span><span class="n">covs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Create one cov</span>
                <span class="n">Xgp</span> <span class="o">=</span> <span class="p">[</span><span class="n">orders</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">]</span>
                <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ccov</span> <span class="o">=</span> <span class="n">sd</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">ExpQuad</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">)</span>
                <span class="n">covs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccov</span><span class="p">)</span>

            <span class="c1"># Make Gaussian process and condition on data</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">MarginalKron</span><span class="p">(</span><span class="n">mean_func</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov_funcs</span><span class="o">=</span><span class="n">covs</span><span class="p">)</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">marginal_likelihood</span><span class="p">(</span><span class="s1">&#39;cs_observed&#39;</span><span class="p">,</span> <span class="n">Xs</span><span class="o">=</span><span class="n">Xgp</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

        <span class="c1"># For user access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covs</span> <span class="o">=</span> <span class="n">covs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccov</span> <span class="o">=</span> <span class="n">ccov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">gp</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">setup_Deltak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get relevant variables</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">)</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RV</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span>
        <span class="n">Q_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span>

        <span class="c1"># Set up variance matrix due to Q array</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">]</span>
        <span class="n">Qr</span><span class="p">,</span> <span class="n">Qc</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">rows</span><span class="p">],</span> <span class="n">Q</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
        <span class="n">varQ</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qr</span> <span class="o">*</span> <span class="n">Qc</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Qr</span> <span class="o">*</span> <span class="n">Qc</span><span class="p">)</span>

        <span class="c1"># Define variables for the Deltak process</span>
        <span class="n">Dk_mean</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mu</span> <span class="o">*</span> <span class="n">Q</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Q</span><span class="p">))</span>
        <span class="n">Dk_cov</span> <span class="o">=</span> <span class="n">varQ</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccov</span>
        <span class="n">Dk_sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">Q_est</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">tt</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Q_est</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>  <span class="c1"># Ensure Deltak belongs to this model context</span>
            <span class="c1"># In general, Q variance removes any potential Kronecker structure</span>
            <span class="n">Dk_gp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Marginal</span><span class="p">(</span><span class="n">mean_func</span><span class="o">=</span><span class="n">Dk_mean</span><span class="p">,</span> <span class="n">cov_func</span><span class="o">=</span><span class="n">Dk_cov</span><span class="p">)</span>
            <span class="n">Dk</span> <span class="o">=</span> <span class="n">Dk_gp</span><span class="o">.</span><span class="n">marginal_likelihood</span><span class="p">(</span>
                <span class="s1">&#39;Dk&#39;</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">Dk_sigma</span><span class="p">,</span> <span class="n">is_observed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="InCoeffs"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.InCoeffs">[docs]</a><span class="k">class</span> <span class="nc">InCoeffs</span><span class="p">(</span><span class="n">CoeffBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The observables are treated as sums of weighted Gaussian random variables.</span>

<span class="sd">    [description]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">rm_orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Q_est</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InCoeffs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">rm_orders</span><span class="o">=</span><span class="n">rm_orders</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
            <span class="n">Q_est</span><span class="o">=</span><span class="n">Q_est</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cksq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_a_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_c</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="k">def</span> <span class="nf">_b_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cksq</span>
        <span class="k">return</span> <span class="n">b</span> <span class="o">+</span> <span class="n">data</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="k">def</span> <span class="nf">var_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">invgamma</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_n</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_b_n</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">error_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">qsq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsq</span>
        <span class="n">a_n</span><span class="p">,</span> <span class="n">b_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a_n</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b_n</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b_n</span> <span class="o">*</span> <span class="n">qsq</span> <span class="o">/</span> <span class="n">a_n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsk</span>
            <span class="n">scale</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span>
        <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">a_n</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">error_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Deltak</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">Dk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Deltak</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">Dk</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<div class="viewcode-block" id="InCoeffs.error_interval"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.InCoeffs.error_interval">[docs]</a>    <span class="k">def</span> <span class="nf">error_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the centered degree of belief interval for Delta_k</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float or ndarray</span>
<span class="sd">            The specifies the 100*alpha% interval</span>
<span class="sd">        a : float</span>
<span class="sd">            The hyperparameter of the variance prior `InvGam(a, b)`</span>
<span class="sd">        b : float</span>
<span class="sd">            The hyperparameter of the variance prior `InvGam(a, b)`</span>
<span class="sd">        rescale : bool, optional</span>
<span class="sd">            Whether or not the dimensionless error is scaled relative to the</span>
<span class="sd">            highest order observable obs_k, that is, obs_k + ref * error, the</span>
<span class="sd">            default is True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            The lower and upper bounds of the error interval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">)</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="c1"># if rescale:</span>
        <span class="c1">#     obsk, ref = self.obsk, self.ref</span>
        <span class="c1">#     low, up = obsk + ref*low, obsk + ref*up</span>
        <span class="k">return</span> <span class="n">low</span><span class="p">,</span> <span class="n">up</span></div>

    <span class="k">def</span> <span class="nf">fQ_prior_logpdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fQ</span><span class="p">,</span> <span class="n">a_fQ</span><span class="p">,</span> <span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># if inverted:</span>
        <span class="c1">#     prior = st.invgamma(a=a_fQ, scale=b_fQ)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     # Use rate param for consistency: b=1/scale</span>
        <span class="c1">#     scale = 1.0/b_fQ</span>
        <span class="c1">#     prior = st.gamma(a=a_fQ, scale=scale)</span>
        <span class="c1"># return prior</span>
        <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
            <span class="n">logpdf</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">fQ</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_fQ</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">logpdf</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">fQ</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logpdf</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">fQ</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_fQ</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logpdf</span>

<div class="viewcode-block" id="InCoeffs.fQ_ulogpdf"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.InCoeffs.fQ_ulogpdf">[docs]</a>    <span class="k">def</span> <span class="nf">fQ_ulogpdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fQ</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_fQ</span><span class="p">,</span> <span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The unnormalized logpdf for the expansion parameter.</span>

<span class="sd">        See the docstring for expar_pdf.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle scaling and inverting</span>
        <span class="c1"># x = x/scale</span>
        <span class="c1"># x = np.atleast_2d(x).T</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">fQ</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># if np.any(Q &gt;= 1):</span>
        <span class="c1">#     raise ValueError(&#39;Q must be between 0 and 1&#39;)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Set up terms</span>
        <span class="n">orders</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">Q_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_est</span>
        <span class="n">cs_Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cn</span><span class="o">*</span><span class="p">(</span><span class="n">Q_est</span><span class="o">/</span><span class="n">Q</span><span class="p">)</span><span class="o">**</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">cn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">cs</span><span class="p">)])</span>
        <span class="n">cksq_Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cs_Q</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">a_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a_n</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">b_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b_n</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cksq_Q</span><span class="p">)</span>
        <span class="n">logp</span> <span class="o">=</span> <span class="o">-</span> <span class="n">a_n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">b_n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">log_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fQ_prior_logpdf</span><span class="p">(</span><span class="n">fQ</span><span class="p">,</span> <span class="n">a_fQ</span><span class="p">,</span> <span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">inverted</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
            <span class="n">logp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">logp</span> <span class="o">+=</span> <span class="n">log_prior</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logp</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">log_prior</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">logp</span> <span class="o">=</span> <span class="n">logp</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">logp</span></div>

<div class="viewcode-block" id="InCoeffs.fQ_pdf"><a class="viewcode-back" href="../../api/models.html#buqeyemodel.models.InCoeffs.fQ_pdf">[docs]</a>    <span class="k">def</span> <span class="nf">fQ_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fQ</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_fQ</span><span class="p">,</span> <span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The approximately normalized pdf for the expansion parameter.</span>

<span class="sd">        The pdf is normalized using the trapezoid rule based on the input</span>
<span class="sd">        points fQ. Hence fine grids that capture the probability mass will</span>
<span class="sd">        be accurately normalized.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fQ : ndarray</span>
<span class="sd">            A function f of the expansion parameter Q: f(Q)</span>
<span class="sd">        a : float</span>
<span class="sd">            [description]</span>
<span class="sd">        b : float</span>
<span class="sd">            [description]</span>
<span class="sd">        a_expar : float</span>
<span class="sd">            [description]</span>
<span class="sd">        b_expar : float</span>
<span class="sd">            [description]</span>
<span class="sd">        scale : float, optional</span>
<span class="sd">            [description] the default is 1.0</span>
<span class="sd">        inverted : bool, optional</span>
<span class="sd">            [description] (the default is False, which [default_description])</span>
<span class="sd">        combine : bool, optional</span>
<span class="sd">            Whether the obserables should use a common expansion parameter, the</span>
<span class="sd">            default is True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The pdf for f(Q)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fQ_ulogpdf</span><span class="p">(</span><span class="n">fQ</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_fQ</span><span class="p">,</span> <span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
                               <span class="n">inverted</span><span class="o">=</span><span class="n">inverted</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="n">combine</span><span class="p">)</span>
        <span class="c1"># Reduce underflow and overflow</span>
        <span class="n">maxlogp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">logp</span> <span class="o">=</span> <span class="n">logp</span> <span class="o">-</span> <span class="n">maxlogp</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logp</span><span class="p">)</span>

        <span class="c1"># Integrate using trapezoid rule</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">fQ</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pdf</span><span class="o">/</span><span class="n">norm</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">fQ_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fQ</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_fQ</span><span class="p">,</span> <span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fQ_pdf</span><span class="p">(</span><span class="n">fQ</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_fQ</span><span class="p">,</span> <span class="n">b_fQ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
                          <span class="n">inverted</span><span class="o">=</span><span class="n">inverted</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="n">combine</span><span class="p">)</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">cumtrapz</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">fQ</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Invert cdf</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;alpha must be between 0 and 1 inclusive&quot;</span><span class="p">)</span>
        <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cdf</span><span class="o">-</span><span class="n">q1</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cdf</span><span class="o">-</span><span class="n">q2</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fQ</span><span class="p">[</span><span class="n">low</span><span class="p">],</span> <span class="n">fQ</span><span class="p">[</span><span class="n">up</span><span class="p">]</span></div>
</pre></div>

          </div>
            
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">buqeyemodel 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2018, Jordan Melendez. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>